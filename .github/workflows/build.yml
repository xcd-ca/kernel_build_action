name: Build Xiaomi 11 Star Kernel (SukiSU + DTBO)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 安装基础依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc bison flex libssl-dev libelf-dev clang lld llvm tar cpio perl python3 git wget

      - name: 2. 拉取内核源码与编译器
        run: |
          git clone --depth=1 -b miui-t https://github.com/tanz3/kernel_xiaomi_sm8350-miui kernel
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
          git clone --depth=1 https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 -b android12-release gcc64
          git clone --depth=1 https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9 -b android12-release gcc32

      - name: 3. 注入 SukiSU (KernelSU + SusFS) - 自动寻源版
        run: |
          cd kernel
          # 安装基础 KSU
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s v0.9.5
          
          mkdir -p arch/arm64/include/asm/
          
          # 【核武器】智能下载函数：遍历多个源，直到成功为止
          download_file() {
            local filepath=$1
            shift
            for url in "$@"; do
              echo "正在尝试拉取: $url"
              # -fL 参数：遇到 404 默默失败并继续，遇到重定向自动跟随
              if curl -fL "$url" -o "$filepath"; then
                echo "✅ 成功下载到 $filepath"
                return 0
              fi
            done
            echo "❌ 所有备用源全部阵亡，找不到 $filepath"
            return 1
          }

          echo "开始拉取 susfs.h..."
          download_file "arch/arm64/include/asm/susfs.h" \
            "https://raw.githubusercontent.com/rifsxd/susfs4linux/master/5.4/arch/arm64/include/asm/susfs.h" \
            "https://raw.githubusercontent.com/Tanuj2004/susfs4linux/master/5.4/arch/arm64/include/asm/susfs.h" \
            "https://gitlab.com/simonpunk/susfs4linux/-/raw/maco/5.4/arch/arm64/include/asm/susfs.h" \
            "https://gitlab.com/simonpunk/susfs4linux/-/raw/master/5.4/arch/arm64/include/asm/susfs.h" \
            "https://raw.githubusercontent.com/WildPlusMiner/susfs4linux/master/5.4/arch/arm64/include/asm/susfs.h" \
            "https://raw.githubusercontent.com/TheRealVun/susfs4linux/main/5.4/arch/arm64/include/asm/susfs.h" || exit 1

          echo "开始拉取 susfs.c..."
          download_file "fs/susfs.c" \
            "https://raw.githubusercontent.com/rifsxd/susfs4linux/master/5.4/fs/susfs.c" \
            "https://raw.githubusercontent.com/Tanuj2004/susfs4linux/master/5.4/fs/susfs.c" \
            "https://gitlab.com/simonpunk/susfs4linux/-/raw/maco/5.4/fs/susfs.c" \
            "https://gitlab.com/simonpunk/susfs4linux/-/raw/master/5.4/fs/susfs.c" \
            "https://raw.githubusercontent.com/WildPlusMiner/susfs4linux/master/5.4/fs/susfs.c" \
            "https://raw.githubusercontent.com/TheRealVun/susfs4linux/main/5.4/fs/susfs.c" || exit 1

          echo "所有核心文件下载完成，注入补丁..."
          sed -i '/obj-y += devpts.o/a obj-y += susfs.o' fs/Makefile

          # 注入 Susfs 到 KernelSU 内部，这次用官方 rifsxd 的主源 (因为最稳)
          wget https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next/kernel/susfs_handler.inc -O KernelSU/kernel/susfs_handler.inc || exit 1
          sed -i '/#include "selinux.h"/a #include "susfs_handler.inc"' KernelSU/kernel/ksu.c
          echo "SukiSU 注入完毕！"

      - name: 4. 配置合并与环境修复
        run: |
          cd kernel
          cat arch/arm64/configs/vendor/lahaina-qgki_defconfig \
              arch/arm64/configs/vendor/xiaomi_QGKI.config \
              arch/arm64/configs/vendor/star_QGKI.config > arch/arm64/configs/star_merged_defconfig
          
          echo "CONFIG_LOCALVERSION=\"-SukiSU-Star\"" >> arch/arm64/configs/star_merged_defconfig
          # 开启 KSU 和 SusFS
          echo "CONFIG_KSU=y" >> arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_KSU_SUSFS=y" >> arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_SUSFS_ALLOW_KSU_VERSION_CHECK=y" >> arch/arm64/configs/star_merged_defconfig
          
          echo "CONFIG_LTO_NONE=y" >> arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_CC_STACKPROTECTOR_NONE=y" >> arch/arm64/configs/star_merged_defconfig

      - name: 5. 编译内核与 DTBO (修复震动的关键)
        run: |
          cd kernel
          export PATH=$GITHUB_WORKSPACE/clang/bin:$GITHUB_WORKSPACE/gcc64/bin:$GITHUB_WORKSPACE/gcc32/bin:$PATH
          ln -sf /usr/bin/ld.lld $GITHUB_WORKSPACE/clang/bin/ld.lld
          
          make O=out ARCH=arm64 star_merged_defconfig
          
          # 必须同时生成 Image 和 dtbo.img
          make -j$(nproc --all) O=out ARCH=arm64 \
               CC=clang \
               CLANG_TRIPLE=aarch64-linux-gnu- \
               CROSS_COMPILE=aarch64-linux-android- \
               CROSS_COMPILE_ARM32=arm-linux-androideabi- \
               LD=ld.lld Image dtbo.img

      - name: 6. 提取纯净镜像文件
        run: |
          mkdir -p output
          cp kernel/out/arch/arm64/boot/Image output/
          cp kernel/out/arch/arm64/boot/dtbo.img output/

      - name: 7. 上传供搞机助手使用的成品
        uses: actions/upload-artifact@v4
        with:
          name: Xiaomi-11-Star-Images
          path: output/*
