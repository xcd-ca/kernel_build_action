name: Build Xiaomi 11 Star Kernel (Fix Linker & Vibration)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc bison flex libssl-dev libelf-dev clang lld llvm tar cpio perl python3 git zip wget

      - name: 2. æ‹‰å–æºç  (Star 5.4)
        run: |
          git clone --depth=1 -b miui-t https://github.com/tanz3/kernel_xiaomi_sm8350-miui kernel
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
          git clone --depth=1 https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 -b android12-release gcc64
          git clone --depth=1 https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9 -b android12-release gcc32

      - name: 3. é›†æˆåŸºç¡€ KernelSU
        run: |
          cd kernel
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s v0.9.5

      - name: 4. å¼ºåˆ¶å†…æ ¸ç‰ˆæœ¬ä¸èº«ä»½è¯ä¼ªè£… (æ‰‹æœ¯çº§ä¿®å¤)
        run: |
          cd kernel
          # 1. æš´åŠ›é™çº§å†…æ ¸ä¸»ç‰ˆæœ¬å·ï¼šå°† 5.4.278 å¼ºåˆ¶æ”¹ä¸º 5.4.233
          # è¿™æ˜¯ä¿®å¤éœ‡åŠ¨çš„æ ¸å¿ƒï¼šè®©é©±åŠ¨è®¤ä¸ºå†…æ ¸è¿˜æ˜¯æ—§ç‰ˆ
          sed -i 's/^SUBLEVEL =.*/SUBLEVEL = 233/' Makefile
          
          # 2. å½»åº•æŠ¹é™¤é‚£ä¸ªè¯¥æ­»çš„ "+" å·å’Œ Git è‡ªåŠ¨åç¼€
          # å±è”½è„šæœ¬ä¸­æ£€æµ‹ Git çŠ¶æ€å¹¶æ·»åŠ  "+" çš„é€»è¾‘
          sed -i 's/echo "+"/#echo "+"/g' scripts/setlocalversion
          # åŒæ—¶ä¹Ÿå±è”½æ‰è‡ªåŠ¨è¿½åŠ  git hash çš„é€»è¾‘ï¼Œé˜²æ­¢å‡ºç°ç±»ä¼¼ -gbb70cde...-dirty
          sed -i 's/res="$res${scm_info}"/#res="$res${scm_info}"/g' scripts/setlocalversion
          
          # 3. åˆå¹¶é…ç½®å¹¶æ³¨å…¥èº«ä»½è¯
          cat arch/arm64/configs/vendor/lahaina-qgki_defconfig \
              arch/arm64/configs/vendor/xiaomi_QGKI.config \
              arch/arm64/configs/vendor/star_QGKI.config > arch/arm64/configs/star_merged_defconfig
          
          # å¼ºåˆ¶å…³é—­è‡ªåŠ¨ç‰ˆæœ¬è¿½åŠ ï¼Œé”å®š LOCALVERSION
          sed -i 's/CONFIG_LOCALVERSION_AUTO=y/CONFIG_LOCALVERSION_AUTO=n/g' arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_LOCALVERSION_AUTO=n" >> arch/arm64/configs/star_merged_defconfig
          # æ³¨å…¥ç²¾å‡†çš„å®˜æ–¹åç¼€ï¼Œä¸å¸¦ä»»ä½•ç©ºæ ¼æˆ–å¤šä½™ç¬¦å·
          echo 'CONFIG_LOCALVERSION="-qgki-gbb70cde46897"' >> arch/arm64/configs/star_merged_defconfig
          
          # 4. å †æ ˆä¿æŠ¤è¡¥ä¸ï¼ˆé˜²æ­¢ç¼–è¯‘æŠ¥é”™ï¼‰
          sed -i 's/CONFIG_STACKPROTECTOR=y/CONFIG_STACKPROTECTOR=n/g' arch/arm64/configs/star_merged_defconfig
          sed -i 's/CONFIG_STACKPROTECTOR_STRONG=y/CONFIG_STACKPROTECTOR_STRONG=n/g' arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_STACKPROTECTOR=n" >> arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_STACKPROTECTOR_STRONG=n" >> arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_CC_STACKPROTECTOR_NONE=y" >> arch/arm64/configs/star_merged_defconfig
          
          # 5. æ³¨å…¥ KernelSU
          echo "CONFIG_KSU=y" >> arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_BUILD_ARM64_DTBO_IMG=y" >> arch/arm64/configs/star_merged_defconfig

      - name: 5. æ­£å¼ç¼–è¯‘ (é”å®šç‰ˆæœ¬å˜é‡)
        run: |
          cd kernel
          rm -rf $GITHUB_WORKSPACE/clang/bin/ld
          ln -sf /usr/bin/ld.lld $GITHUB_WORKSPACE/clang/bin/ld
          export PATH=$GITHUB_WORKSPACE/clang/bin:$GITHUB_WORKSPACE/gcc64/bin:$GITHUB_WORKSPACE/gcc32/bin:$PATH
          
          # ç”Ÿæˆæœ€ç»ˆé…ç½®
          make O=out ARCH=arm64 star_merged_defconfig
          
          # å†æ¬¡ç¡®è®¤ SUBLEVEL ç¡®å®è¢«ä¿®æ”¹äº†ï¼ˆåŒé‡ä¿é™©ï¼‰
          sed -i 's/^SUBLEVEL =.*/SUBLEVEL = 233/' out/.config || true

          # ç¼–è¯‘å‘½ä»¤ä¸­æ˜¾å¼ä¼ é€’ LOCALVERSIONï¼Œè¦†ç›–æ‰€æœ‰å¯èƒ½çš„è„šæœ¬å¹²æ‰°
          # è¿™é‡Œçš„ KBUILD_BUILD_VERSION å¯ä»¥éšä¾¿å†™ï¼Œä¸å½±å“éœ‡åŠ¨
          make -j$(nproc --all) O=out ARCH=arm64 \
               CC=clang HOSTCC=gcc \
               KCFLAGS="-fno-stack-protector" \
               CLANG_TRIPLE=aarch64-linux-gnu- \
               CROSS_COMPILE=aarch64-linux-android- \
               CROSS_COMPILE_ARM32=arm-linux-androideabi- \
               LD=ld.lld \
               KBUILD_BUILD_USER="Xiaomi" \
               KBUILD_BUILD_HOST="Official" \
               LOCALVERSION="-qgki-gbb70cde46897" \
               Image
      - name: 6. æå–é•œåƒ (å…¨ç›˜æš´åŠ›æœç´¢)
        run: |
          mkdir -p output
          # 1. æå–å†…æ ¸æœ¬ä½“ (å·²ç»ç¡®å®šç¼–è¯‘æˆåŠŸäº†)
          if [ -f kernel/out/arch/arm64/boot/Image ]; then
            cp kernel/out/arch/arm64/boot/Image output/
            echo "âœ… æˆåŠŸæ‰¾åˆ°å†…æ ¸ Image"
          fi
          
          # 2. æš´åŠ›æœç´¢ dtbo æ–‡ä»¶
          echo "ğŸ” æ­£åœ¨å…¨ç›˜æœå¯» dtbo æ–‡ä»¶..."
          
          # ç›´æ¥ä» out æ ¹ç›®å½•å¼€å§‹æœï¼Œä¸ç®¡å®ƒåœ¨å“ªä¸ªæ–‡ä»¶å¤¹
          # æˆ‘ä»¬æ‰¾åå­—åŒ…å« star ä¸”ä»¥ .dtbo ç»“å°¾çš„æ–‡ä»¶
          DTBO_PATH=$(find kernel/out -name "*star*.dtbo" | head -n 1)
          
          # å¦‚æœæ²¡æ‰¾åˆ°å¸¦ star çš„ï¼Œå°±æœä»»ä½•åŒ…å« lahaina çš„ (å°ç±³11æ˜¯ lahaina å¹³å°)
          if [ -z "$DTBO_PATH" ]; then
            DTBO_PATH=$(find kernel/out -name "*lahaina*.dtbo" | head -n 1)
          fi

          if [ ! -z "$DTBO_PATH" ]; then
            echo "ğŸ¯ æˆåŠŸå®šä½ DTBO æ–‡ä»¶: $DTBO_PATH"
            cp "$DTBO_PATH" output/dtbo.img
          else
            echo "âŒ è­¦å‘Šï¼šä»æœªæ‰¾åˆ° .dtbo æ–‡ä»¶ï¼"
            echo "ç›®å‰å·²ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨å¦‚ä¸‹(è°ƒè¯•ç”¨):"
            find kernel/out -name "*.dtbo" || echo "ç¡®å®æ²¡æœ‰ä»»ä½• .dtbo ç”Ÿæˆ"
          fi

          # 3. æ£€æŸ¥å¹¶å±•ç¤ºæœ€ç»ˆäº§ç‰©
          echo "ğŸ“¦ æœ€ç»ˆäº§ç‰©åˆ—è¡¨:"
          ls -lh output/

      - name: 7. ä¸Šä¼ 
        uses: actions/upload-artifact@v4
        with:
          name: Mi11-Star-VibeFix-Images
          path: output/*
