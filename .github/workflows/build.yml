name: Build Xiaomi 11 Star Kernel (SukiSU Ultra + DTBO)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 安装基础依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc bison flex libssl-dev libelf-dev clang lld llvm tar cpio perl python3 git zip wget

      - name: 2. 拉取内核源码 (Xiaomi 11 Star)
        run: |
          git clone --depth=1 -b miui-t https://github.com/tanz3/kernel_xiaomi_sm8350-miui kernel
          
      - name: 3. 拉取编译器 (Proton Clang)
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
          git clone --depth=1 https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 -b android12-release gcc64
          git clone --depth=1 https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9 -b android12-release gcc32

      - name: 4. 集成 KernelSU 和 Susfs (SukiSU Ultra 核心)
        run: |
          cd kernel
          # 1. 集成 KernelSU v0.9.5
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s v0.9.5
          
          # 2. 【核心修复】不使用 git clone，直接下载 SusFS 核心文件 (尝试多个镜像源)
          mkdir -p arch/arm64/include/asm/
          wget https://raw.githubusercontent.com/sidex15/susfs4linux/main/5.4/arch/arm64/include/asm/susfs.h -O arch/arm64/include/asm/susfs.h || \
          wget https://raw.githubusercontent.com/TheRealVun/susfs4linux/main/5.4/arch/arm64/include/asm/susfs.h -O arch/arm64/include/asm/susfs.h
          
          wget https://raw.githubusercontent.com/sidex15/susfs4linux/main/5.4/fs/susfs.c -O fs/susfs.c || \
          wget https://raw.githubusercontent.com/TheRealVun/susfs4linux/main/5.4/fs/susfs.c -O fs/susfs.c
          
          # 3. 注入 Susfs 到内核编译系统
          sed -i '/obj-y += devpts.o/a obj-y += susfs.o' fs/Makefile
          
          # 4. 【关键】为 SukiSU Ultra 注入内核 Hook (手动修改内核源码)
          # 在 fs/open.c 中注入 Hook
          sed -i '/include <linux\/fs_struct.h>/a #include <asm/susfs.h>' fs/open.c
          # 在 fs/stat.c 中注入 Hook
          sed -i '/include <linux\/syscalls.h>/a #include <asm/susfs.h>' fs/stat.c

          # 5. 集成 Susfs 到 KernelSU 内部 (SukiSU Handler)
          wget https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next/kernel/susfs_handler.inc -O KernelSU/kernel/susfs_handler.inc
          sed -i '/#include "selinux.h"/a #include "susfs_handler.inc"' KernelSU/kernel/ksu.c

      - name: 5. 合并配置并开启所有开关
        run: |
          cd kernel
          cat arch/arm64/configs/vendor/lahaina-qgki_defconfig \
              arch/arm64/configs/vendor/xiaomi_QGKI.config \
              arch/arm64/configs/vendor/star_QGKI.config > arch/arm64/configs/star_merged_defconfig
          
          # 注入自定义名称
          echo "CONFIG_LOCALVERSION=\"-Star-SukiSU-$(date +%m%d)\"" >> arch/arm64/configs/star_merged_defconfig
          
          # 开启内核底层支持
          echo "CONFIG_KPROBES=y" >> arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_HAVE_KPROBES=y" >> arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_KPROBE_EVENTS=y" >> arch/arm64/configs/star_merged_defconfig
          
          # 开启 SukiSU / Susfs 关键开关
          echo "CONFIG_KSU=y" >> arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_KSU_SUSFS=y" >> arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_SUSFS_ALLOW_KSU_VERSION_CHECK=y" >> arch/arm64/configs/star_merged_defconfig
          
          # 修复堆栈报错并优化编译
          echo "CONFIG_LTO_NONE=y" >> arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_CC_STACKPROTECTOR_NONE=y" >> arch/arm64/configs/star_merged_defconfig

      - name: 6. 正式编译 (Image + DTBO)
        run: |
          cd kernel
          export PATH=$GITHUB_WORKSPACE/clang/bin:$GITHUB_WORKSPACE/gcc64/bin:$GITHUB_WORKSPACE/gcc32/bin:$PATH
          
          # 强制链接 Ubuntu 的 LLD 修复环境问题
          ln -sf /usr/bin/ld.lld $GITHUB_WORKSPACE/clang/bin/ld.lld
          
          make O=out ARCH=arm64 star_merged_defconfig
          
          # 核心编译：Image 和 dtbo.img 缺一不可
          make -j$(nproc --all) O=out ARCH=arm64 \
               CC=clang \
               CLANG_TRIPLE=aarch64-linux-gnu- \
               CROSS_COMPILE=aarch64-linux-android- \
               CROSS_COMPILE_ARM32=arm-linux-androideabi- \
               LD=ld.lld \
               AR=llvm-ar \
               NM=llvm-nm \
               OBJCOPY=llvm-objcopy \
               OBJDUMP=llvm-objdump \
               STRIP=llvm-strip \
               Image dtbo.img

      - name: 7. 整理 PC 刷机文件
        run: |
          mkdir -p output
          cp kernel/out/arch/arm64/boot/Image output/
          cp kernel/out/arch/arm64/boot/dtbo.img output/
          echo "PC 刷机文件已就绪。Image 用于替换 boot.img 里的内核，dtbo.img 用于修复震动。" > output/使用说明.txt

      - name: 8. 上传成品
        uses: actions/upload-artifact@v4
        with:
          name: Xiaomi-11-Star-SukiSU-PC-Files
          path: output/*
