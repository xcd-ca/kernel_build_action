name: Build Xiaomi 11 Star Kernel (Fix Linker & Vibration)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 安装基础依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc bison flex libssl-dev libelf-dev clang lld llvm tar cpio perl python3 git zip wget

      - name: 2. 拉取源码 (Star 5.4)
        run: |
          git clone --depth=1 -b miui-t https://github.com/tanz3/kernel_xiaomi_sm8350-miui kernel
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
          git clone --depth=1 https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 -b android12-release gcc64
          git clone --depth=1 https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9 -b android12-release gcc32

      - name: 3. 集成基础 KernelSU
        run: |
          cd kernel
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s v0.9.5

      - name: 4. 强制合并配置 (彻底解决堆栈保护报错)
        run: |
          cd kernel
          # 1. 合并基础配置
          cat arch/arm64/configs/vendor/lahaina-qgki_defconfig \
              arch/arm64/configs/vendor/xiaomi_QGKI.config \
              arch/arm64/configs/vendor/star_QGKI.config > arch/arm64/configs/star_merged_defconfig
          
          # 2. 【核心修复】使用 sed 强行关闭所有堆栈保护选项，防止符号未定义报错
          sed -i 's/CONFIG_STACKPROTECTOR=y/CONFIG_STACKPROTECTOR=n/g' arch/arm64/configs/star_merged_defconfig
          sed -i 's/CONFIG_STACKPROTECTOR_STRONG=y/CONFIG_STACKPROTECTOR_STRONG=n/g' arch/arm64/configs/star_merged_defconfig
          
          # 3. 注入 KSU 和 震动修复配置
          echo "CONFIG_CC_STACKPROTECTOR_NONE=y" >> arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_LOCALVERSION=\"-Star-KSU-VibeFix\"" >> arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_KSU=y" >> arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_BUILD_ARM64_DTBO_IMG=y" >> arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_LTO_NONE=y" >> arch/arm64/configs/star_merged_defconfig

      - name: 5. 正式编译
        run: |
          cd kernel
          rm -rf $GITHUB_WORKSPACE/clang/bin/ld
          ln -sf /usr/bin/ld.lld $GITHUB_WORKSPACE/clang/bin/ld
          export PATH=$GITHUB_WORKSPACE/clang/bin:$GITHUB_WORKSPACE/gcc64/bin:$GITHUB_WORKSPACE/gcc32/bin:$PATH
          
          # 关键：先生成配置，再执行 olddefconfig 确保关掉了 STACK_PROTECTOR
          make O=out ARCH=arm64 star_merged_defconfig
          make O=out ARCH=arm64 olddefconfig
          
          # 正式开始，增加 HOSTCC 明确指定
          make -j$(nproc --all) O=out ARCH=arm64 \
               CC=clang \
               HOSTCC=gcc \
               CLANG_TRIPLE=aarch64-linux-gnu- \
               CROSS_COMPILE=aarch64-linux-android- \
               CROSS_COMPILE_ARM32=arm-linux-androideabi- \
               LD=ld.lld \
               AR=llvm-ar \
               NM=llvm-nm \
               OBJCOPY=llvm-objcopy \
               OBJDUMP=llvm-objdump \
               STRIP=llvm-strip \
               Image dtbo.img || make -j$(nproc --all) O=out ARCH=arm64 \
               CC=clang \
               HOSTCC=gcc \
               CLANG_TRIPLE=aarch64-linux-gnu- \
               CROSS_COMPILE=aarch64-linux-android- \
               CROSS_COMPILE_ARM32=arm-linux-androideabi- \
               LD=ld.lld dtbs

      - name: 6. 提取镜像 (智能查找)
        run: |
          mkdir -p output
          # 拷贝内核
          [ -f kernel/out/arch/arm64/boot/Image ] && cp kernel/out/arch/arm64/boot/Image output/
          
          # 拷贝 DTBO (如果生成了 dtbo.img 就直接拿，否则去 dtbs 目录里捞 star 专用的)
          if [ -f kernel/out/arch/arm64/boot/dtbo.img ]; then
            cp kernel/out/arch/arm64/boot/dtbo.img output/
          else
            echo "未直接生成 dtbo.img，正在搜索 dtbo 文件..."
            # 小米 11 star 的 dtbo 通常叫 star.dtbo 或包含 star 字符
            find kernel/out/arch/arm64/boot/dts/vendor/qcom/ -name "*star*.dtbo" -exec cp {} output/dtbo.img \;
          fi

      - name: 7. 上传
        uses: actions/upload-artifact@v4
        with:
          name: Mi11-Star-VibeFix-Images
          path: output/*
