name: Build Star Kernel (Merge Config)
on:
  workflow_dispatch:

jobs:
  Build-Kernel:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v3

      - name: Prepare Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev libelf-dev bc bison flex libncurses5-dev
          mkdir -p $GITHUB_WORKSPACE/kernel_workspace

      - name: Build Kernel
        uses: dabao1955/kernel_build_action@main
        with:
          kernel-url: https://github.com/tanz3/kernel_xiaomi_sm8350-miui
          kernel-dir: msm-5.4
          kernel-branch: miui-t
          
          # 【核心黑科技】在这里直接注入合并命令
          # 我们在生成配置前，强行把三个碎片合并成一个名为 star_defconfig 的文件
          config: star_defconfig
          custom-commands: |
            cat arch/arm64/configs/vendor/lahaina-qgki_defconfig \
                arch/arm64/configs/vendor/xiaomi_QGKI.config \
                arch/arm64/configs/vendor/star_QGKI.config > arch/arm64/configs/star_defconfig
          
          arch: arm64
          android-version: 12
          aosp-gcc: true
          aosp-clang: true
          aosp-clang-version: r416183b1
          
          ksu: true
          ksu-version: main
          disable-lto: true
          anykernel3: true
