name: Build Xiaomi 11 Star Kernel
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 安装基础依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc bison flex libssl-dev libelf-dev clang lld llvm tar cpio perl python3 git zip wget

      - name: 2. 拉取内核源码
        run: |
          # 深度设为 1 节省空间和时间
          git clone --depth=1 -b miui-t https://github.com/tanz3/kernel_xiaomi_sm8350-miui kernel
          
      - name: 3. 拉取编译器 (使用顶级的 Proton Clang)
        run: |
          # 直接从 GitHub 极速拉取 Proton Clang，告别网络和权限报错
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
          
          # 拉取 GCC 交叉编译器 (Google 源的这两个没问题，继续保留)
          git clone --depth=1 https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 -b android12-release gcc64
          git clone --depth=1 https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9 -b android12-release gcc32

      - name: 4. 核心步骤：强行合并小米 11 配置文件
        run: |
          cd kernel
          # 1. 基础合并
          cat arch/arm64/configs/vendor/lahaina-qgki_defconfig \
              arch/arm64/configs/vendor/xiaomi_QGKI.config \
              arch/arm64/configs/vendor/star_QGKI.config > arch/arm64/configs/star_merged_defconfig
          
          # 2. 注入个性化和修复参数
          echo "CONFIG_LOCALVERSION=\"-Star-KSU-$(date +%m%d)\"" >> arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_LTO_NONE=y" >> arch/arm64/configs/star_merged_defconfig
          
          # 【重点：修复 __stack_chk_guard 报错】
          echo "CONFIG_STACKPROTECTOR=n" >> arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_STACKPROTECTOR_STRONG=n" >> arch/arm64/configs/star_merged_defconfig
          echo "CONFIG_CC_STACKPROTECTOR_NONE=y" >> arch/arm64/configs/star_merged_defconfig

      - name: 5. 集成 KernelSU (v0.9.5)
        run: |
          cd kernel
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s v0.9.5

      - name: 6. 开始正式编译 (带补丁版)
        run: |
          cd kernel
          # 设置环境变量
          export PATH=$GITHUB_WORKSPACE/clang/bin:$GITHUB_WORKSPACE/gcc64/bin:$GITHUB_WORKSPACE/gcc32/bin:$PATH
          
          # 【补丁核心】强行让内核使用系统自带的 /usr/bin/ld 替代工具链里那个过时的 ld
          # 这样它就能识别 Ubuntu 24.04 的库文件格式了
          ln -sf /usr/bin/ld.lld $GITHUB_WORKSPACE/clang/bin/ld.lld
          ln -sf /usr/bin/ld.bfd $GITHUB_WORKSPACE/clang/bin/ld
          
          # 生成 .config 文件
          make O=out ARCH=arm64 star_merged_defconfig
          
          # 执行编译，增加一些兼容性参数
          make -j$(nproc --all) O=out ARCH=arm64 \
               CC=clang \
               CLANG_TRIPLE=aarch64-linux-gnu- \
               CROSS_COMPILE=aarch64-linux-android- \
               CROSS_COMPILE_ARM32=arm-linux-androideabi- \
               LD=ld.lld \
               AR=llvm-ar \
               NM=llvm-nm \
               OBJCOPY=llvm-objcopy \
               OBJDUMP=llvm-objdump \
               STRIP=llvm-strip \
               HOSTCFLAGS="-fuse-ld=lld" \
               HOSTLDFLAGS="-L/usr/lib/x86_64-linux-gnu"

      - name: 7. 检查编译结果并打包 AnyKernel3
        run: |
          if [ -f kernel/out/arch/arm64/boot/Image ]; then
            git clone --depth=1 https://github.com/osm0sis/AnyKernel3
            cp kernel/out/arch/arm64/boot/Image AnyKernel3/
            cd AnyKernel3
            # 适配小米 11 (star)
            sed -i 's/device.name1=maguro/device.name1=star/' anykernel.sh
            sed -i 's/device.name2=panda/device.name2=mars/' anykernel.sh
            zip -r ../Star-Kernel-KSU-$(date +%Y%m%d).zip *
          else
            echo "错误：编译未生成 Image 文件，请检查编译日志。"
            exit 1
          fi

      - name: 8. 上传成品
        uses: actions/upload-artifact@v4
        with:
          name: Star-Kernel-KSU
          path: "*.zip"
